#!/usr/bin/env bash
set -euo pipefail

# --- Chargement des variables ---
ENV_FILE="/opt/keycloak/.env"
[ -f "$ENV_FILE" ] || { echo "‚ùå ERR: $ENV_FILE introuvable"; exit 1; }
set -a; source "$ENV_FILE"; set +a
# Variables attendues : KEYCLOAK_ADMIN, KEYCLOAK_ADMIN_PASSWORD, KEYCLOAK_REALM, DOMAIN

# --- Constantes/chemins ---
COMPOSE="/opt/keycloak/docker-compose.yml"
SERVICE="keycloak"
KCADM="/opt/keycloak/bin/kcadm.sh"

# Ex√©cuter une commande dans le conteneur Keycloak
dc() { docker compose -f "$COMPOSE" exec -T "$SERVICE" bash -lc "$*"; }

# --- Attente de disponibilit√© ---
echo "‚è≥ [init] Attente que Keycloak soit pr√™t..."
for i in {1..60}; do
  if dc "export KCADM_CONFIG=/tmp/kcadm.config && \
         $KCADM config credentials --server http://localhost:8080 \
         --realm master --user '${KEYCLOAK_ADMIN}' --password '${KEYCLOAK_ADMIN_PASSWORD}'"; then
    echo "‚úÖ [init] Login admin OK"
    break
  fi
  sleep 2
  [[ $i -eq 60 ]] && { echo "‚ùå ERR: Keycloak pas pr√™t"; exit 1; }
done

REALM="${KEYCLOAK_REALM}"
BASE_DOMAIN="${DOMAIN}"

# ============================
# üìÇ REALM
# ============================
echo -e "\n=== üìÇ Gestion du Realm ==="
if dc "$KCADM get realms/${REALM}" >/dev/null 2>&1; then
  echo "‚ÑπÔ∏è Realm '${REALM}' existe d√©j√†."
else
  echo "‚ûï Cr√©ation du realm '${REALM}'..."
  dc "$KCADM create realms -s realm='${REALM}' -s enabled=true"
fi

# ============================
# üîë ROLES
# ============================
echo -e "\n=== üîë Gestion des R√¥les ==="
for role in ia-admin devops-admin cyber-admin; do
  if dc "$KCADM get roles -r ${REALM}" | grep -q "\"name\" : \"${role}\""; then
    echo "‚ÑπÔ∏è R√¥le '${role}' existe d√©j√†."
  else
    echo "‚ûï Cr√©ation du r√¥le '${role}'..."
    dc "$KCADM create roles -r ${REALM} -s name=${role}"
  fi
done

# ============================
# üë• GROUPES
# ============================
echo -e "\n=== üë• Gestion des Groupes ==="
for group in STARTER PRO ENTERPRISE; do
  if dc "$KCADM get groups -r ${REALM} -q search=${group} --fields name" | grep -q "\"name\" : \"${group}\""; then
    echo "‚ÑπÔ∏è Groupe '${group}' existe d√©j√†."
  else
    echo "‚ûï Cr√©ation du groupe '${group}'..."
    dc "$KCADM create groups -r ${REALM} -s name=${group}"
  fi
done

# ============================
# üîó ROLES ‚Üí GROUPES
# ============================
echo -e "\n=== üîó Association R√¥les ‚Üí Groupes ==="
get_group_id() {
  local name="$1"
  dc "$KCADM get groups -r ${REALM} -q search=${name} --fields id,name" \
  | awk -v pat="\"name\" : \""$name"\"" -F\" '$0 ~ pat {f=1} f && /"id"/ {print $4; exit}'
}
STARTER_ID="$(get_group_id STARTER || true)"
PRO_ID="$(get_group_id PRO || true)"
ENTERPRISE_ID="$(get_group_id ENTERPRISE || true)"

for mapping in \
  "$STARTER_ID:ia-admin" \
  "$PRO_ID:ia-admin" "$PRO_ID:devops-admin" \
  "$ENTERPRISE_ID:ia-admin" "$ENTERPRISE_ID:devops-admin" "$ENTERPRISE_ID:cyber-admin"; do
  gid="${mapping%%:*}"
  role="${mapping##*:}"
  if [ -n "$gid" ]; then
    echo "‚ûï Association r√¥le '${role}' ‚Üí groupe '${gid}'"
    dc "$KCA=DM add-roles -r ${REALM} --gid ${gid} --rolename ${role}" || true
  fi
done

# ============================
# üåê CLIENTS + MAPPERS
# ============================
echo -e "\n=== üåê Gestion des Clients & Mappers ==="

get_client_uuid() {
  local cid="$1"
  dc "$KCADM get clients -r ${REALM} -q clientId=${cid} --fields id" \
  | awk -F\" '/"id"/{print $4; exit}'
}

create_client () {
  local cid="$1"
  local redirect="https://${cid}.${BASE_DOMAIN}/login/oidc/callback"
  local origin="https://${cid}.${BASE_DOMAIN}"

  # --- Client ---
  if dc "$KCADM get clients -r ${REALM} -q clientId=${cid} --fields clientId" | grep -q "\"clientId\" : \"${cid}\""; then
    echo "‚ÑπÔ∏è Client '${cid}' existe d√©j√†."
  else
    echo "‚ûï Cr√©ation du client '${cid}'..."
    dc "$KCADM create clients -r ${REALM} -f - <<JSON
{ \"clientId\":\"${cid}\", \"protocol\":\"openid-connect\", \"publicClient\":false,
  \"standardFlowEnabled\":true, \"redirectUris\":[\"${redirect}\"],
  \"webOrigins\":[\"${origin}\"] }
JSON"
  fi

  # --- R√©cup√©ration de l'UUID ---
  local uuid
  uuid="$(get_client_uuid "${cid}")"
  [ -n "${uuid:-}" ] || { echo "‚ùå ERR: UUID client ${cid} introuvable"; exit 1; }

  # --- Helpers pour mapper ---
  add_mapper () {
    local name="$1" mapper="$2" extra="$3"
    if dc "$KCADM get clients/${uuid}/protocol-mappers/models -r ${REALM} --fields name" | grep -q "\"name\" : \"${name}\""; then
      echo "‚ÑπÔ∏è Mapper '${name}' d√©j√† pr√©sent pour ${cid}."
    else
      echo "‚ûï Ajout du mapper '${name}' pour ${cid}..."
      dc "$KCADM create clients/${uuid}/protocol-mappers/models -r ${REALM} -f - <<JSON
{ \"name\":\"${name}\", \"protocol\":\"openid-connect\", \"protocolMapper\":\"${mapper}\", \"config\": ${extra} }
JSON"
    fi
  }

  # --- Ajout des mappers standards ---
  add_mapper "email"              "oidc-usermodel-property-mapper" \
    "{ \"claim.name\":\"email\", \"user.attribute\":\"email\", \"id.token.claim\":\"true\", \"access.token.claim\":\"true\", \"userinfo.token.claim\":\"true\" }"

  add_mapper "preferred_username" "oidc-usermodel-property-mapper" \
    "{ \"claim.name\":\"preferred_username\", \"user.attribute\":\"username\", \"id.token.claim\":\"true\", \"access.token.claim\":\"true\", \"userinfo.token.claim\":\"true\" }"

  add_mapper "given_name"         "oidc-usermodel-property-mapper" \
    "{ \"claim.name\":\"given_name\", \"user.attribute\":\"firstName\", \"id.token.claim\":\"true\", \"access.token.claim\":\"true\", \"userinfo.token.claim\":\"true\" }"

  add_mapper "family_name"        "oidc-usermodel-property-mapper" \
    "{ \"claim.name\":\"family_name\", \"user.attribute\":\"lastName\", \"id.token.claim\":\"true\", \"access.token.claim\":\"true\", \"userinfo.token.claim\":\"true\" }"

  add_mapper "groups"             "oidc-group-membership-mapper" \
    "{ \"full.path\":\"false\", \"claim.name\":\"groups\", \"id.token.claim\":\"true\", \"access.token.claim\":\"true\", \"userinfo.token.claim\":\"true\" }"

  add_mapper "roles"              "oidc-usermodel-realm-role-mapper" \
    "{ \"multivalued\":\"true\", \"claim.name\":\"roles\", \"jsonType.label\":\"String\", \"id.token.claim\":\"true\", \"access.token.claim\":\"true\", \"userinfo.token.claim\":\"true\" }"
}

# --- Cr√©er les clients attendus ---
create_client "wiki-ia"
create_client "wiki-devops"
create_client "wiki-cyber"
